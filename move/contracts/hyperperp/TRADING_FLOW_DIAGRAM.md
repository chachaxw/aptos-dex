# 永续合约撮合交易流程图

## 完整交易流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            永续合约撮合交易完整流程                                │
└─────────────────────────────────────────────────────────────────────────────────┘

阶段 1: 系统初始化
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1.1 配置模块初始化                                                                │
│     aptos move run --function-id "0x{admin}::config::init"                     │
│     └─ 设置 USDC 元数据                                                         │
│                                                                                 │
│ 1.2 治理模块初始化                                                                │
│     aptos move run --function-id "0x{admin}::gov::init_admins_single"          │
│     └─ 设置管理员权限                                                             │
│                                                                                 │
│ 1.3 事件系统初始化                                                                │
│     aptos move run --function-id "0x{admin}::events::init_events"              │
│     └─ 初始化事件存储                                                             │
│                                                                                 │
│ 1.4 金库初始化                                                                   │
│     aptos move run --function-id "0x{admin}::vault_coin::init_ledger"          │
│     └─ 初始化资金金库                                                             │
│                                                                                 │
│ 1.5 预言机初始化                                                                  │
│     aptos move run --function-id "0x{admin}::oracle_adapter::init"             │
│     └─ 设置价格过期时间                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 2: 用户账户初始化
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 2.1 创建 Alice 账户                                                              │
│     aptos move run --function-id "0x{admin}::account::open" --profile alice     │
│     └─ 创建 Account 资源，包含抵押品、未结算 PnL 等                              │
│                                                                                 │
│ 2.2 创建 Bob 账户                                                                │
│     aptos move run --function-id "0x{admin}::account::open" --profile bob       │
│     └─ 创建 Account 资源，包含抵押品、未结算 PnL 等                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 3: 资金管理
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 3.1 Alice 存入资金                                                              │
│     aptos move run --function-id "0x{admin}::vault_coin::deposit"              │
│     └─ 用户 USDC → 金库 USDC                                                    │
│     └─ 用户账户抵押品增加                                                        │
│     └─ 触发 DepositEvent 事件                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 4: 价格推送
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 4.1 推送市场价格                                                                  │
│     aptos move run --function-id "0x{admin}::oracle_adapter::push_price"       │
│     └─ 推送 BTC 价格: 30,000 USDC                                               │
│     └─ 设置价格置信度和时间戳                                                    │
│     └─ 用于交易价格验证                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 5: 撮合交易执行
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 5.1 执行撮合交易批次结算                                                          │
│     aptos move run --function-id "0x{admin}::perp_engine::apply_batch_simple"  │
│     │                                                                           │
│     ├─ 交易参数:                                                                 │
│     │   • Taker: Alice (买方)                                                   │
│     │   • Maker: Bob (卖方)                                                     │
│     │   • 市场ID: 1 (BTC)                                                       │
│     │   • 交易量: 1 合约                                                         │
│     │   • 价格: 30,000 USDC                                                     │
│     │   • 手续费: 10 bps                                                        │
│     │                                                                           │
│     ├─ 价格保护:                                                                 │
│     │   • 最小价格: 29,000 USDC                                                 │
│     │   • 最大价格: 31,000 USDC                                                 │
│     │                                                                           │
│     ├─ 时间保护:                                                                 │
│     │   • 交易时间戳验证                                                         │
│     │   • 过期时间检查                                                           │
│     │                                                                           │
│     └─ 链上状态更新:                                                             │
│         • 更新 Alice 和 Bob 的持仓                                               │
│         • 计算并收取手续费                                                       │
│         • 执行资金转移                                                           │
│         • 触发 FillEvent 和 PositionUpdateEvent 事件                           │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 6: 资金结算
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 6.1 为 Bob 提取资金                                                              │
│     aptos move run --function-id "0x{admin}::vault_coin::withdraw_for"         │
│     └─ 金库 USDC → Bob USDC                                                     │
│     └─ Bob 账户抵押品减少                                                        │
│     └─ 触发 WithdrawEvent 事件                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    ↓
阶段 7: 状态验证
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 7.1 余额检查                                                                     │
│     • Alice 余额变化: 减少 3 USDC (支付交易)                                     │
│     • Bob 余额变化: 增加 3 USDC (收到交易款)                                     │
│                                                                                 │
│ 7.2 持仓检查                                                                     │
│     • Alice 持仓: 1 合约多头 (BTC)                                              │
│     • Bob 持仓: 1 合约空头 (BTC)                                                │
│                                                                                 │
│ 7.3 事件检查                                                                     │
│     • DepositEvent: Alice 存款事件                                              │
│     • FillEvent: 交易成交事件                                                    │
│     • PositionUpdateEvent: 持仓更新事件                                          │
│     • WithdrawEvent: Bob 提款事件                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

## 关键数据结构

### BatchFill (撮合交易数据)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ struct BatchFill {                                                              │
│     taker: address,      // 买方地址 (Alice)                                    │
│     maker: address,      // 卖方地址 (Bob)                                      │
│     market_id: u64,      // 市场ID (1 = BTC)                                   │
│     size: u128,          // 交易数量 (1 合约)                                   │
│     price_x: u64,        // 价格 (30000000 = 30,000 USDC)                      │
│     fee_bps: u64,        // 手续费 (10 bps)                                    │
│     ts: u64              // 时间戳                                              │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Position (持仓数据)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ struct Position {                                                               │
│     owner: address,           // 持仓者地址                                      │
│     market_id: u64,           // 市场ID                                         │
│     size: u128,               // 持仓数量                                       │
│     is_long: bool,            // 是否多头 (true=多头, false=空头)                │
│     entry_notional: u128,     // 开仓名义价值                                    │
│     funding_acc: u128,        // 资金费率累计                                    │
│     last_updated: u64,        // 最后更新时间                                    │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 手续费机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 手续费分配:                                                                      │
│                                                                                 │
│ 总手续费 = 交易名义价值 × 手续费率 (10 bps)                                      │
│                                                                                 │
│ ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│ │   Taker 手续费   │    │   Maker 返佣     │    │   协议手续费     │              │
│ │   (100%)        │ =  │   (50%)         │ +  │   (50%)         │              │
│ │   支付完整费用    │    │   获得返佣       │    │   协议收入       │              │
│ └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 风险控制机制

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1. 价格保护                                                                      │
│    • 交易价格必须在 [min_price, max_price] 范围内                               │
│    • 防止价格操纵和异常交易                                                      │
│                                                                                 │
│ 2. 时间保护                                                                      │
│    • 交易必须在 expiry 时间前执行                                               │
│    • 防止过期交易执行                                                            │
│                                                                                 │
│ 3. 抵押品检查                                                                    │
│    • 交易前检查用户抵押品是否充足                                                │
│    • 维护保证金要求                                                              │
│                                                                                 │
│ 4. 权限控制                                                                      │
│    • 大部分操作需要管理员权限                                                    │
│    • 用户只能操作自己的账户                                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 事件系统

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 主要事件类型:                                                                    │
│                                                                                 │
│ • DepositEvent      - 存款事件 (Alice 存入资金)                                 │
│ • WithdrawEvent     - 提款事件 (Bob 提取资金)                                   │
│ • FillEvent         - 成交事件 (撮合交易执行)                                   │
│ • PositionUpdateEvent - 持仓更新事件 (Alice/Bob 持仓变化)                       │
│ • PositionCloseEvent  - 平仓事件 (持仓关闭)                                     │
│ • FundingEvent      - 资金费率事件 (定期资金费率更新)                           │
│ • LiquidationEvent  - 清算事件 (强制平仓)                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 测试验证

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 运行测试:                                                                        │
│                                                                                 │
│ 1. 完整测试:                                                                     │
│    ./sh_scripts/complete_trading_test.sh                                        │
│                                                                                 │
│ 2. 简化测试:                                                                     │
│    ./sh_scripts/simple_trading_test.sh                                         │
│                                                                                 │
│ 验证要点:                                                                        │
│ • 所有交易成功执行                                                               │
│ • 余额变化正确                                                                   │
│ • 持仓状态更新                                                                   │
│ • 事件正确触发                                                                   │
│ • 链上状态一致                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```
