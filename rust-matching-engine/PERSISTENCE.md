# æ•°æ®æŒä¹…åŒ–è¯´æ˜

## ğŸ“Š æ•°æ®å­˜å‚¨æ¶æ„

æœ¬æ’®åˆå¼•æ“ç°åœ¨æ”¯æŒåŒé‡æŒä¹…åŒ–å­˜å‚¨ï¼š

### 1. PostgreSQL - ä¸»æ•°æ®åº“
- **ç”¨é€”**: æŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰å…³é”®æ•°æ®
- **å­˜å‚¨å†…å®¹**:
  - è®¢å•æ•°æ® (`orders` è¡¨)
  - äº¤æ˜“è®°å½• (`trades` è¡¨)
  - ç»“ç®—æ‰¹æ¬¡ (`settlement_batches` è¡¨)

### 2. Redis - ç¼“å­˜å’Œå®æ—¶æ•°æ®
- **ç”¨é€”**: é«˜æ€§èƒ½ç¼“å­˜å’Œå®æ—¶æ•°æ®å­˜å‚¨
- **å­˜å‚¨å†…å®¹**:
  - è®¢å•ç°¿ç¼“å­˜ (`orderbook:*`)
  - è®¢å•ç¼“å­˜ (`order:*`)
  - å¸‚åœºç»Ÿè®¡ (`market_stats:*`)
  - æœ€è¿‘äº¤æ˜“ (`recent_trades:*`)

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨æ•°æ®åº“æœåŠ¡
```bash
# å¯åŠ¨ Redis å’Œ PostgreSQL
./start.sh

# æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
docker-compose up -d postgres redis
```

### 2. è¿è¡Œæ’®åˆå¼•æ“
```bash
cargo run
```

### 3. æµ‹è¯•æŒä¹…åŒ–åŠŸèƒ½
```bash
# è¿è¡ŒæŒä¹…åŒ–æµ‹è¯•
cargo run --bin test_persistence
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
```bash
# PostgreSQL é…ç½®
HYPERPERP_DATABASE_URL=postgresql://postgres:password@localhost:5432/hyperperp

# Redis é…ç½®
HYPERPERP_REDIS_URL=redis://localhost:6379
```

### é…ç½®æ–‡ä»¶ (config.toml)
```toml
[server]
host = "127.0.0.1"
port = 8080

[redis]
url = "redis://127.0.0.1:6379"

[aptos]
node_url = "https://fullnode.testnet.aptoslabs.com/v1"
admin_address = "0xa11ce"
admin_private_key = "your_private_key"
contract_address = "0xc0ffee"
chain_id = 2

[settlement]
batch_size = 10
batch_timeout_secs = 5
max_price_slippage = 0.05
```

## ğŸ“ˆ æ•°æ®æµå›¾

```
ç”¨æˆ·æäº¤è®¢å•
    â†“
REST API æ¥æ”¶
    â†“
æ’®åˆå¼•æ“å¤„ç†
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚      Redis      â”‚
â”‚   (æŒä¹…åŒ–)       â”‚     (ç¼“å­˜)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è®¢å•æ•°æ®       â”‚ â€¢ è®¢å•ç°¿ç¼“å­˜     â”‚
â”‚ â€¢ äº¤æ˜“è®°å½•       â”‚ â€¢ è®¢å•ç¼“å­˜       â”‚
â”‚ â€¢ ç»“ç®—æ‰¹æ¬¡       â”‚ â€¢ å¸‚åœºç»Ÿè®¡       â”‚
â”‚ â€¢ å†å²æ•°æ®       â”‚ â€¢ æœ€è¿‘äº¤æ˜“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åŒºå—é“¾ç»“ç®—
```

## ğŸ”„ æ•°æ®åŒæ­¥æœºåˆ¶

### 1. è®¢å•æ•°æ®åŒæ­¥
- **å†™å…¥**: åŒæ—¶å†™å…¥ PostgreSQL å’Œ Redis
- **è¯»å–**: ä¼˜å…ˆä» Redis è¯»å–ï¼Œå¤±è´¥æ—¶ä» PostgreSQL è¯»å–
- **æ›´æ–°**: åŒæ—¶æ›´æ–°ä¸¤ä¸ªå­˜å‚¨

### 2. è®¢å•ç°¿ç¼“å­˜
- **TTL**: 1å°æ—¶è‡ªåŠ¨è¿‡æœŸ
- **æ›´æ–°**: æ¯æ¬¡è®¢å•å˜åŒ–æ—¶æ›´æ–°ç¼“å­˜
- **æ¢å¤**: æœåŠ¡é‡å¯æ—¶ä» PostgreSQL æ¢å¤

### 3. å¸‚åœºç»Ÿè®¡
- **TTL**: 5åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ
- **æ›´æ–°**: å®æ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®
- **æŸ¥è¯¢**: å¿«é€Ÿè·å–å¸‚åœºæ¦‚è§ˆ

## ğŸ› ï¸ å¼€å‘å·¥å…·

### 1. æ•°æ®åº“ç®¡ç†
```bash
# è¿æ¥ PostgreSQL
psql postgresql://postgres:password@localhost:5432/hyperperp

# è¿æ¥ Redis
redis-cli -h localhost -p 6379
```

### 2. ç›‘æ§å‘½ä»¤
```bash
# æŸ¥çœ‹ Redis ç¼“å­˜
redis-cli keys "*"

# æŸ¥çœ‹ç‰¹å®šå¸‚åœºè®¢å•ç°¿
redis-cli get "orderbook:1"

# æŸ¥çœ‹å¸‚åœºç»Ÿè®¡
redis-cli get "market_stats:1"
```

### 3. æ¸…ç†ç¼“å­˜
```bash
# æ¸…ç†æ‰€æœ‰ç¼“å­˜
redis-cli flushall

# æ¸…ç†ç‰¹å®šæ¨¡å¼
redis-cli --scan --pattern "orderbook:*" | xargs redis-cli del
```

## ğŸ” æ•…éšœæ’é™¤

### 1. è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose logs postgres
docker-compose logs redis
```

### 2. æ•°æ®ä¸ä¸€è‡´
```bash
# æ¸…ç† Redis ç¼“å­˜ï¼Œå¼ºåˆ¶ä» PostgreSQL æ¢å¤
redis-cli flushall

# é‡å¯æ’®åˆå¼•æ“
cargo run
```

### 3. æ€§èƒ½é—®é¢˜
```bash
# ç›‘æ§ Redis å†…å­˜ä½¿ç”¨
redis-cli info memory

# ç›‘æ§ PostgreSQL è¿æ¥
psql -c "SELECT * FROM pg_stat_activity;"
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Redis ä¼˜åŒ–
- è®¾ç½®åˆé€‚çš„å†…å­˜é™åˆ¶
- å¯ç”¨æŒä¹…åŒ– (AOF)
- ä½¿ç”¨è¿æ¥æ± 

### 2. PostgreSQL ä¼˜åŒ–
- åˆ›å»ºé€‚å½“çš„ç´¢å¼•
- é…ç½®è¿æ¥æ± 
- å®šæœŸæ¸…ç†å†å²æ•°æ®

### 3. åº”ç”¨ä¼˜åŒ–
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
- å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘
- åˆç†è®¾ç½® TTL é¿å…å†…å­˜æ³„æ¼

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•°æ®åº“å®‰å…¨
- ä½¿ç”¨å¼ºå¯†ç 
- é™åˆ¶ç½‘ç»œè®¿é—®
- å¯ç”¨ SSL è¿æ¥

### 2. Redis å®‰å…¨
- è®¾ç½®å¯†ç è®¤è¯
- é™åˆ¶å‘½ä»¤æ‰§è¡Œ
- ç›‘æ§å¼‚å¸¸è®¿é—®

### 3. åº”ç”¨å®‰å…¨
- è¾“å…¥éªŒè¯
- SQL æ³¨å…¥é˜²æŠ¤
- è®¿é—®æ§åˆ¶

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [Redis å®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [Rust SQLx æ–‡æ¡£](https://docs.rs/sqlx/)
- [Rust Redis æ–‡æ¡£](https://docs.rs/redis/)

